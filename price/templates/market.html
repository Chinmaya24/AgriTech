<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Market Prices</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="mb-4">Market Prices</h1>
        <form id="cropForm" class="row g-3 mb-4">
            <div class="col-auto">
                <label for="crop" class="form-label">Select Crop:</label>
                <select id="crop" name="crop" class="form-select">
                    <option value="Tomato">Tomato</option>
                    <option value="Potato">Potato</option>
                    <option value="Maize">Maize</option>
                    <option value="Onion">Onion</option>
                    <option value="Wheat">Wheat</option>
                    <option value="Rice">Rice</option>
                    <option value="Cotton">Cotton</option>
                    <option value="Groundnut">Groundnut</option>
                    <option value="Soybean">Soybean</option>
                </select>
            </div>
            <div class="col-auto align-self-end">
                <button type="submit" class="btn btn-primary">Get Prices</button>
            </div>
        </form>
        <div id="result">
            <canvas id="priceChart" height="100"></canvas>
            <table class="table table-striped mt-4" id="priceTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Price (₹/quintal)</th>
                        <th>Market</th>
                        <th>State</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
        let chart;
        document.getElementById('cropForm').onsubmit = async function(e) {
            e.preventDefault();
            const crop = document.getElementById('crop').value;
            const response = await fetch('/market', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({crop})
            });
            const data = await response.json();
            // Chart
            const ctx = document.getElementById('priceChart').getContext('2d');
            const labels = data.map(item => item.date);
            const prices = data.map(item => item.price);
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: crop + ' Price (₹/quintal)',
                        data: prices,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true } }
                }
            });
            // Table
            const tbody = document.querySelector('#priceTable tbody');
            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan='4' class='text-center'>No records found</td></tr>`;
            } else {
                data.forEach(item => {
                    const row = `<tr><td>${item.date}</td><td>₹${item.price}</td><td>${item.market || ''}</td><td>${item.state || ''}</td></tr>`;
                    tbody.innerHTML += row;
                });
            }
        };
        // Initial load
        document.getElementById('cropForm').dispatchEvent(new Event('submit'));
    </script>
</body>
</html>
